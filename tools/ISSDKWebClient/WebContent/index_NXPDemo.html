<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<style type="text/css">
h1 {
	font-family: verdana, sans-serif;
	font-weight: bold;
	font-size: 28px;
	text-align: center;
	margin: auto 0px;
}

h2 {
	font-family: verdana, sans-serif;
	font-weight: bold;
	font-size: 15px;
	text-align: center;
	margin: auto 0px;
}

.error {
	color: red;
}

.response {
	color: blue;
}

.command {
	color: green;
}

fieldset {
	font-weight: bold;
	font-size: 15px;
	width: 50%;
	margin: auto;
	text-align: left;
}

chart {
	font-weight: bold;
	font-size: 15px;
	width: 50%;
	margin: auto;
	text-align: left;
}

table, td, th {
	font-family: verdana, sans-serif;
	font-weight: bold;
	font-size: 18px;
	width: 15%;
	margin-left: auto;
	margin-right: auto;
	margin-top: 1em;
	color: blue;
	background-color: #eeeeee;
	padding: 1em;
	border: 1px solid black;
	border: 5px groove #cccccc;
	-moz-border-radius: 10px;
	-webkit-border-radius: 10px;
	-moz-box-shadow: 10px 10px 10px #000000;
	-webkit-box-shadow: 10px 10px 10px #000000;
}

#output {
	font-family: verdana, sans-serif;
	font-weight: bold;
	font-size: 15px;
	width: 50%;
	margin-left: auto;
	margin-right: auto;
	margin-top: 1em;
	background-color: #eeeeee;
	padding: 1em;
	border: 1px solid black;
	border: 5px groove #cccccc;
	-moz-border-radius: 10px;
	-webkit-border-radius: 10px;
	-moz-box-shadow: 10px 10px 10px #000000;
	-webkit-box-shadow: 10px 10px 10px #000000;
}
</style>

<script type="text/javascript">
	const
	START_STREAMING_CMD = "0x7E, 0x21, 0x00, 0x00, 0x02, 0x01, 0x01, 0x7E";
	const
	STOP_STREAMING_CMD = "0x7E, 0x21, 0x00, 0x00, 0x02, 0x02, 0x01, 0x7E";
	const
	SDCD_FF_EVT_ID = 0x01 //FreeFall Event ID
	const
    P_THS_EVENT_ID = 0x02 //Threshold Event ID
	const
	EXIT_CLIENT_CMD = "Exit";
	const
	SERVER_KEEP_ALIVE = "KEEPALIVE";
	var output;
	var websocket;
	var accel_x, accel_y, accel_z;
	var mag_x, mag_y, mag_z;
	var gyro_x, gyro_y, gyro_z;
	var pressure_x, temperature_y;

	var xVal1 = 0;
	var xVal2 = 0;
	var xVal3 = 0;
	var xVal4 = 0;

	var intervalUpdateChart = 100; //100ms
	var intervalKeepAlive = 60000; //1min
	var dataLength = 100; // number of dataPoints visible at any point
	var dpsx = []; // dataPoints
	var dpsy = []; // dataPoints
	var dpsz = []; // dataPoints

	var dps_x2 = []; // dataPoints
	var dps_y2 = []; // dataPoints
	var dps_z2 = []; // dataPoints

	var dps_x3 = []; // dataPoints
	var dps_y3 = []; // dataPoints
	var dps_z3 = []; // dataPoints

	var dps_x4 = []; // dataPoints

	var ts = new Date();
	var keepAliveInterval;

	function init() {
		output = document.getElementById("output");

		var chartAccel = new CanvasJS.Chart("chartAccel", {
			title : {
				text : "3-AXIS Accel Data Plots"
			},
			data : [ {
				type : "line",
				showInLegend : true,
				legendText : "MMA8652:Accel X",
				dataPoints : dpsx
			}, {
				type : "line",
				showInLegend : true,
				legendText : "MMA8652:Accel Y",
				dataPoints : dpsy
			}, {
				type : "line",
				showInLegend : true,
				legendText : "MMA8652:Accel Z",
				dataPoints : dpsz
			}, ]
		});
		var chartMag = new CanvasJS.Chart("chartMag", {
			title : {
				text : "3-AXIS Mag Data Plots"
			},
			data : [ {
				type : "line",
				showInLegend : true,
				legendText : "MAG3110:Mag X",
				dataPoints : dps_x2
			}, {
				type : "line",
				showInLegend : true,
				legendText : "MAG3110:Mag Y",
				dataPoints : dps_y2
			}, {
				type : "line",
				showInLegend : true,
				legendText : "MAG3110:Mag Z",
				dataPoints : dps_z2
			}, ]
		});
		var chartGyro = new CanvasJS.Chart("chartGyro", {
			title : {
				text : "3-AXIS Gyro Data Plots"
			},
			data : [ {
				type : "line",
				showInLegend : true,
				legendText : "FXAS21002:Gyro X",
				dataPoints : dps_x3
			}, {
				type : "line",
				showInLegend : true,
				legendText : "FXAS21002:Gyro Y",
				dataPoints : dps_y3
			}, {
				type : "line",
				showInLegend : true,
				legendText : "FXAS21002:Gyro Z",
				dataPoints : dps_z3
			}, ]
		});
		var chartPress = new CanvasJS.Chart("chartPress", {
			title : {
				text : "1-AXIS Pressure Data Plot"
			},
            axisY:{
                minimum: 90,
                maximum: 120,
            },            
			data : [ {
				type : "line",
				showInLegend : true,
				legendText : "MPL3115:Pressure",
				dataPoints : dps_x4
			} ]
		});

		var updateChart = function(count) {
			count = count || 1;
			// count is number of times loop runs to generate random dataPoints.

			for (var j = 0; j < count; j++) {
				dpsx.push({
					x : xVal1,
					y : accel_x
				});
				dpsy.push({
					x : xVal1,
					y : accel_y
				});
				dpsz.push({
					x : xVal1,
					y : accel_z
				});
				dps_x2.push({
					x : xVal2,
					y : mag_x
				});
				dps_y2.push({
					x : xVal2,
					y : mag_y
				});
				dps_z2.push({
					x : xVal2,
					y : mag_z
				});
				dps_x3.push({
					x : xVal3,
					y : gyro_x
				});
				dps_y3.push({
					x : xVal3,
					y : gyro_y
				});
				dps_z3.push({
					x : xVal3,
					y : gyro_z
				});
				dps_x4.push({
					x : xVal4,
					y : pressure_x
				});
			}
			;
			if (dpsx.length > dataLength) {
				dpsx.shift();
				dpsy.shift();
				dpsz.shift();
				dps_x2.shift();
				dps_y2.shift();
				dps_z2.shift();
				dps_x3.shift();
				dps_y3.shift();
				dps_z3.shift();
				dps_x4.shift();
			}

			chartAccel.render();
			chartMag.render();
			chartGyro.render();
			chartPress.render();

		};
		// generates first set of dataPoints
		updateChart(dataLength);
		// update chart after specified time.
		setInterval(function() {updateChart()}, intervalUpdateChart);
	} // end init

	function flashFreeFallImage() {
		var img = document.getElementById("freeFallImage");
        var audio = new Audio("audio/Beep.mp3");
		// Change the image and play beep to indicate FreeFall.
		img.src="images/FreeFall.png";
        audio.play();
		// Wait for 2 seconds and then display default image.
		setTimeout(function() {img.src="images/Stop.png";}, 2000);
	} // end flashFreeFallImage

	function flashThresholdFallImage() {
		var img = document.getElementById("thresholdImage");
        var audio = new Audio("audio/Beep.mp3");
		// Change the image and play beep to indicate Threshold.
		img.src="images/Threshold.png";
        audio.play();
		// Wait for 2 seconds and then display default image.
		setTimeout(function() {img.src="images/NoThreshold.png";}, 2000);
	} // end flashThresholdFallImage

	function connect() {
		//open socket
		if ("WebSocket" in window) {
			websocket = new WebSocket("ws://NXPConnectedBall.mybluemix.net/ws/sdademoserver");
			output.innerHTML = "Connecting to the Cloud Server...";

			//attach event handlers
			websocket.onopen = onOpen;
			websocket.onclose = onClose;
			websocket.onmessage = onMessage;
			websocket.onerror = onError;
		} else {
			alert("WebSockets not supported on your browser.");
		} // end if
	} // end connect

	function onOpen(evt) {
		//called as soon as a connection is opened
		output.innerHTML = "<p>Connected to Cloud Server</p>";
		// send keepalive to server after specified time.
		keepAliveInterval = setInterval(function() {
			websocket.send(JSON.stringify(SERVER_KEEP_ALIVE));
		}, intervalKeepAlive);
	} // end onOpen

	function onClose(evt) {
		//called when connection is closed
		output.innerHTML += "<p>Disconnected from Cloud Server</p>";
		// stop sending keepalive to server.
		clearInterval(keepAliveInterval);
	} // end onClose;

	function onMessage(evt) {
		//called on receipt of message
		var responsedata = JSON.parse(evt.data);
		var responseString = "";

		// Display Events.
		if (responsedata.Type == "Event") {
			for(var i=0; i < responsedata.Data.length; i++) {
			    responseString += "0x" + responsedata.Data[i].toString(16).toUpperCase();
			    if(i < responsedata.Data.length-1) {
			    	responseString += ", ";
			    }
			}
			output.innerHTML += "<p class = 'command'>REMOTE EVENT: " + responseString + "</p>";
			// Check if FreeFall Event has been reported.
			if (responsedata.Data[4] == SDCD_FF_EVT_ID) {
				flashFreeFallImage();
			}
            // Check if Threshold Event has been reported.
			if (responsedata.Data[4] == P_THS_EVENT_ID) {
				flashThresholdFallImage();
			}
		// Parse Samples for graphing.
		} else {
			accel_x = responsedata.Data[9] << 8 | responsedata.Data[8];
		    if (accel_x > 0x7FFF) {
		    	accel_x -= 0x10000;
		    }
		    accel_x *= 0.00098; // Acceleration in G.

			accel_y = responsedata.Data[11] << 8 | responsedata.Data[10];
		    if (accel_y > 0x7FFF) {
		    	accel_y -= 0x10000;
		    }
		    accel_y *= 0.00098; // Acceleration in G.

			accel_z = responsedata.Data[13] << 8 | responsedata.Data[12];
		    if (accel_z > 0x7FFF) {
		    	accel_z -= 0x10000;
		    }
		    accel_z *= 0.00098; // Acceleration in G.

		    mag_x = responsedata.Data[15] << 8 | responsedata.Data[14];
		    if (mag_x > 0x7FFF) {
		    	mag_x -= 0x10000;
		    }
		    mag_x *= 0.1; // Magnetic Field in micro Tesla.

		    mag_y = responsedata.Data[17] << 8 | responsedata.Data[16];
		    if (mag_y > 0x7FFF) {
		    	mag_y -= 0x10000;
		    }
		    mag_y *= 0.1; // Magnetic Field in micro Tesla.

		    mag_z = responsedata.Data[19] << 8 | responsedata.Data[18];
		    if (mag_z > 0x7FFF) {
		    	mag_z -= 0x10000;
		    }
		    mag_z *= 0.1; // Magnetic Field in micro Tesla.

		    gyro_x = responsedata.Data[21] << 8 | responsedata.Data[20];
		    if (gyro_x > 0x7FFF) {
		    	gyro_x -= 0x10000;
		    }
		    gyro_x *= 0.0625; // Angular Velocity in degrees/seconds

		    gyro_y = responsedata.Data[23] << 8 | responsedata.Data[22];
		    if (gyro_y > 0x7FFF) {
		    	gyro_y -= 0x10000;
		    }
		    gyro_y *= 0.0625; // Angular Velocity in degrees/seconds

		    gyro_z = responsedata.Data[25] << 8 | responsedata.Data[24];
		    if (gyro_z > 0x7FFF) {
		    	gyro_z -= 0x10000;
		    }
		    gyro_z *= 0.0625; // Angular Velocity in degrees/seconds

		    pressure_x  = (responsedata.Data[29] <<24 | responsedata.Data[28] <<16 | responsedata.Data[27] <<8 | responsedata.Data[26])/4000.0; // Pressure in kilo Pascals.

		    temperature_y = responsedata.Data[31] <<8  | responsedata.Data[30];
		    if (temperature_y > 0x7FFF) {
		    	temperature_y -= 0x10000;
		    }
		    temperature_y /= 16.0; // Temperature in Celsius.
		    temperature_y = (temperature_y*1.8) + 32; // Temperature in Fahrenheit.

			document.getElementById('xAxisData').innerHTML = accel_x.toFixed(2)
			document.getElementById('yAxisData').innerHTML = accel_y.toFixed(2)
			document.getElementById('zAxisData').innerHTML = accel_z.toFixed(2)
			xVal1++;

			document.getElementById('x2AxisData').innerHTML = mag_x.toFixed(2)
			document.getElementById('y2AxisData').innerHTML = mag_y.toFixed(2)
			document.getElementById('z2AxisData').innerHTML = mag_z.toFixed(2)
			xVal2++;

			document.getElementById('x3AxisData').innerHTML = gyro_x.toFixed(2)
			document.getElementById('y3AxisData').innerHTML = gyro_y.toFixed(2)
			document.getElementById('z3AxisData').innerHTML = gyro_z.toFixed(2)
			xVal3++;

			document.getElementById('x4AxisData').innerHTML = pressure_x.toFixed(2)
			document.getElementById('y4AxisData').innerHTML = temperature_y.toFixed(2)
			xVal4++;
		}
	} // end onMessage

	function onError(evt) {
		//called on error
		output.innerHTML += "<p class = 'error'>ERROR: " + evt.data + "</p>";
	} // end onError
</script>
<script type="text/javascript" src="canvasjs.min.js"></script>

</head>
<body onload="init()">
	<header>
		<figure>
			<h1>
				ISSDK powered - NXP Connected Soccer Ball <br>
				<img src="http://www.nxp.com/assets/images/en/photography/Booth-NXP.jpg" alt="Smart Society" height="300px" width="400px">
				<img src="images/FRDM-STBC-KIT.png" alt="Demonstration Kit" height="300px" width="300px">
				<img src="https://cnet3.cbsistatic.com/img/13EwGOFK4zLUg4iASxv4HLZ4Jbk=/770x578/2016/09/30/8f2dfede-4e82-4a87-86b0-80f225bc77d3/wilson-x-connected-football-20.jpg" alt="Demonstration Kit" height="300px" width="300px">
			</h1>
		</figure>
	</header>

	<br>
	<h1>11 Axis Digital Sensor Data</h1> <br>
	<h2>(MMA8652, MAG3110, FXAS21002, MPL3115)</h2>
	<table>
		<tr>
			<th>Accel_X(g)</th>
			<th>Accel_Y(g)</th>
			<th>Accel_Z(g)</th>
			<th>Mag_X(µT)</th>
			<th>Mag_Y(µT)</th>
			<th>Mag_Z(µT)</th>
		</tr>
		<tr>
			<td width="10" align="center" valign="middle">
				<div id="xAxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="yAxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="zAxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="x2AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="y2AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="z2AxisData"></div>
			</td>
		</tr>
	</table>
	<table>
		<tr>
			<th>Gyro_X(°/s)</th>
			<th>Gyro_Y(°/s)</th>
			<th>Gyro_Z(°/s)</th>
			<th>Pressure(kPa)</th>
			<th>Temperature(°F)</th>
		</tr>
		<tr>
			<td width="10" align="center" valign="middle">
				<div id="x3AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="y3AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="z3AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="x4AxisData"></div>
			</td>
			<td width="10" align="center" valign="middle">
				<div id="y4AxisData"></div>
			</td>
		</tr>
	</table>
	<br><br>
	<div id="chartAccel" style="height: 275px; width: 100%;"></div>
	<div id="chartMag" style="height: 275px; width: 100%;"></div>
	<div id="chartGyro" style="height: 275px; width: 100%;"></div>
	<div id="chartPress" style="height: 275px; width: 100%;"></div>
	<br>
	<footer>
		<fieldset>
			<button type="button" style="font-size: 20px" onclick="connect()">
				<i>Connect to the Cloud Server</i></button>
			<button type="button" style="font-size: 20px" onclick="websocket.close()">
			    <i>Disconnect from the Cloud Server</i></button>
			<br>
            <button type="button"
                style="font-size: 20px; background-color: gold" disabled>FreeFall >></button>
            <img id="freeFallImage" src="images/Stop.png" align="top" style="width: 30px; height: 30px;">
            <button type="button"
                style="font-size: 20px; background-color: gold" disabled>Threshold >></button>
            <img id="thresholdImage" src="images/NoThreshold.png" align="top" style="width: 30px; height: 30px;">
			<br>
		</fieldset>
		<br>
		<h2>Event Window</h2>
		<div id="output"></div>
		<hr/>
		<h2>©2017 NXP Semiconductors. All rights reserved.</h2>
	</footer>
</body>
</html>
